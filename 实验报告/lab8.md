#lab8文件系统

#实验目的

- 了解文件系统抽象层-VFS的设计与实现
- 了解基于索引节点组织方式的Simple FS文件系统与操作的设计与实现
- 了解“一切皆为文件”思想的设备文件设计
- 了解简单系统终端的实现

#练习1: 完成读文件操作的实现（需要编码）
首先了解打开文件的处理流程，然后参考本实验后续的文件读写操作的过程分析，填写在 kern/fs/sfs/sfs_inode.c中 的sfs_io_nolock()函数，实现读文件中数据的代码。


#练习2: 完成基于文件系统的执行程序机制的实现（需要编码）
改写proc.c中的load_icode函数和其他相关函数，实现基于文件系统的执行程序机制。执行：make qemu。如果能看看到sh用户程序的执行界面，则基本成功了。如果在sh用户界面上可以执行”ls”,”hello”等其他放置在sfs文件系统中的其他执行程序，则可以认为本实验基本成功。

#扩展练习 Challenge1：完成基于“UNIX的PIPE机制”的设计方案

如果要在ucore里加入UNIX的管道（Pipe)机制，至少需要定义哪些数据结构和接口？（接口给出语义即可，不必具体实现。数据结构的设计应当给出一个(或多个）具体的C语言struct定义。在网络上查找相关的Linux资料和实现，请在实验报告中给出设计实现”UNIX的PIPE机制“的概要设方案，你的设计应当体现出对可能出现的同步互斥问题的处理。）

##“UNIX的PIPE机制是什么”
基于“UNIX的PIPE机制”是一种进程间通信的机制，它允许一个进程将输出直接发送给另一个进程作为输入，从而实现进程间的数据传输。在UNIX系统中，每个进程都有三个标准的I/O流：标准输入（stdin）、标准输出（stdout）和标准错误输出（stderr）。PIPE机制利用了这些标准流，通过创建一个管道连接两个进程的标准输入和标准输出，实现数据的传输。

具体而言，PIPE机制通过创建一个管道文件来连接两个进程。一个进程将数据写入管道的写入端，而另一个进程从管道的读取端读取数据。这样，数据就可以从一个进程流向另一个进程，实现进程间的通信。

PIPE机制的设计方案可以包括以下步骤：
1、创建一个管道文件：使用系统调用函数pipe()创建一个管道文件，该函数返回两个文件描述符，一个用于写入数据，一个用于读取数据。
2、创建两个进程：使用系统调用函数fork()创建两个进程，一个作为数据的生产者，另一个作为数据的消费者。
3、在生产者进程中写入数据：将要传输的数据写入管道的写入端，使用系统调用函数write()将数据写入管道。
4、在消费者进程中读取数据：从管道的读取端读取数据，使用系统调用函数read()读取管道中的数据。
5、关闭管道文件描述符：在数据传输完成后，关闭管道的文件描述符，使用系统调用函数close()关闭文件描述符。
6、处理数据：根据需要对读取的数据进行处理，可以在消费者进程中对数据进行操作或输出。

通过使用“UNIX的PIPE机制”，可以方便地实现进程间的数据传输，提高系统的灵活性和效率。
#扩展练习 Challenge2：完成基于“UNIX的软连接和硬连接机制”的设计方案
如果要在ucore里加入UNIX的软连接和硬连接机制，至少需要定义哪些数据结构和接口？（接口给出语义即可，不必具体实现。数据结构的设计应当给出一个(或多个）具体的C语言struct定义。在网络上查找相关的Linux资料和实现，请在实验报告中给出设计实现”UNIX的软连接和硬连接机制“的概要设方案，你的设计应当体现出对可能出现的同步互斥问题的处理。）
##"基于UNIX的软连接和硬连接是什么"
基于"UNIX的软连接和硬连接机制"是一种在UNIX操作系统中使用的文件系统链接机制。软连接和硬连接是用于在文件系统中创建文件或目录之间的链接关系的方法。

1、软连接（Symbolic Link）：
软连接也称为符号链接，它是一个指向另一个文件或目录的特殊文件。软连接创建一个新的文件，其中包含指向原始文件或目录的路径。软连接的创建和使用类似于Windows操作系统中的快捷方式。软连接可以跨越不同的文件系统，甚至可以指向不存在的文件或目录。删除原始文件或目录不会影响软连接，但是如果删除了软连接本身，原始文件或目录将不受影响。

2、硬连接（Hard Link）：
硬连接是指在文件系统中创建一个新的文件名，它与原始文件共享相同的索引节点（inode）。硬连接创建一个指向原始文件的新文件名，实际上它们指向同一个物理数据块。硬连接可以在同一文件系统中创建，但不能跨越不同的文件系统。删除任何一个硬连接不会影响原始文件，因为它们共享相同的索引节点。

软连接和硬连接的使用场景有所不同：

软连接适用于跨文件系统链接、链接不存在的文件或目录、创建快捷方式等情况。
硬连接适用于创建多个文件名指向相同的文件内容，共享硬盘空间、提供文件备份和版本控制等情况。
需要注意的是，软连接和硬连接可能会导致循环链接的问题，即文件A链接到文件B，而文件B又链接到文件A。这种情况可能导致文件系统的无限循环，并且需要小心处理以避免此类问题。



#Lab8文件系统初始化过程

kern_init函数,增加了对fs_init函数的调用,fs_init函数就是文件系统初始化的总控函数，它进一步调用了虚拟文件系统初始化函数vfs_init，与文件相关的设备初始化函数dev_init和Simple FS文件系统的初始化函数sfs_init。这三个初始化函数联合在一起，协同完成了整个虚拟文件系统、SFS文件系统和文件系统对应的设备（键盘、串口、磁盘）的初始化工作。

vfs_init主要建立了一个device list双向链表vdev_list，为后续具体设备（键盘、串口、磁盘）以文件的形式呈现建立查找访问通道。dev_init函数通过进一步调用disk0/stdin/stdout_device_init完成对具体设备的初始化，把它们抽象成一个设备文件，并建立对应的inode数据结构，最后把它们链入到vdev_list中。这样通过虚拟文件系统就可以方便地以文件的形式访问这些设备了。sfs_init是完成对Simple FS的初始化工作，并把此实例文件系统挂在虚拟文件系统中，从而让ucore的其他部分能够通过访问虚拟文件系统的接口来进一步访问到SFS实例文件系统。

#文件系统概述

计算机保存维护，文件系统。

逻辑上相关联，文件。

处理具体设备，具体协议并向上提供简单接口的软件，我们叫做设备驱动(device driver)，简称驱动。

#虚拟文件系统

虚拟文件系统的功能：用同样的接口进行使用不同的设备。


#UNIX文件系统
- 超级块（superblock）
- 
- 索引节点（inode）
- 文件（file）
- 目录项（dentry）

#ucore文件系统总体结构

- superblock：全局角度描述特定文件系统的全局信息。它的作用范围是整个 OS 空间。
- 索引节点（inode）：它主要从文件系统的单个文件的角度它描述了文件的各种属性和数据所在位置。它的作用范围是整个 OS 空间。
- 目录项（dentry）：它主要从文件系统的文件路径的角度描述了文件路径中的一个特定的目录项（注：一系列目录项形成目录/文件路径）。它的作用范围是整个 OS 空间。对于 SFS 而言，inode(具体为 struct sfs_disk_inode)对应于物理磁盘上的具体对象，dentry（具体为 struct sfs_disk_entry）是一个内存实体，其中的 ino 成员指向对应的 inode number，另外一个成员是 file name(文件名).
- 文件（file），它主要从进程的角度描述了一个进程在访问文件时需要了解的文件标识，文件读写的位置，文件引用情况等信息。它的作用范围是某一具体进程。

#ucore文件系统总体介绍

- 硬盘，我们管理硬盘的具体文件系统是Simple File System（地位和Ext2等文件系统相同）
- 标准输出（控制台输出），只能写不能读
- 标准输入（键盘输入），只能读不能写


我们的“硬盘”依然需要通过用一块内存来模拟。

- 通用文件系统访问接口层：该层提供了一个从用户空间到文件系统的标准访问接口。

- 文件系统抽象层：向上提供一个一致的接口给内核其他部分（文件系统相关的系统调用实现模块和其他内核功能模块）访问。向下提供一个同样的抽象函数指针列表和数据结构屏蔽不同文件系统的实现细节。

-Simple FS 文件系统层：一个基于索引方式的简单文件系统实例。向上通过各种具体函数实现以对应文件系统抽象层提出的抽象函数。向下访问外设接口


-外设接口层：向上提供 device 访问接口屏蔽不同硬件细节。向下实现访问各种具体设备驱动的接口，比如 disk 设备接口/串口设备接口/键盘设备接口等。


#文件系统抽象层VFS

- 文件系统抽象层是把不同文件系统的对外共性接口提取出来，形成一个函数指针数组，这样，通用文件系统访问接口层只需访问文件系统抽象层，而不需关心具体文件系统的实现细节和接口。

#file&dir interface

#inode
- 内存的索引节点
- 它实际负责把不同文件系统的特定索引节点信息（甚至不能算是一个索引节点）统一封装起来，避免了进程直接访问具体文件系统。

- inode_ops 是对常规文件、目录、设备文件所有操作的一个抽象函数表示。对于某一具体的文件系统中的文件或目录，只需实现相关的函数，就可以被用户进程访问具体的文件了，且用户进程无需了解具体文件系统的实现细节。


#硬盘文件系统SFS
- 第 0 个块（4K）是超级块（superblock），它包含了关于文件系统的所有关键参数，当计算机被启动或文件系统被首次接触时，超级块的内容就会被装入内存。

- 在 sfs_fs.c 文件中的 sfs_do_mount 函数中，完成了加载位于硬盘上的 SFS 文件系统的超级块 superblock 和 freemap 的工作。这样，在内存中就有了 SFS 文件系统的全局信息。


#索引节点

- 在 SFS 文件系统中，需要记录文件内容的存储位置以及文件名与文件内容的对应关系。sfs_disk_inode 记录了文件或目录的内容存储的索引信息，该数据结构在硬盘里储存，需要时读入内存（从磁盘读进来的是一段连续的字节，我们将这段连续的字节强制转换成sfs_disk_inode结构体；同样，写入的时候换一个方向强制转换）。sfs_disk_entry 表示一个目录中的一个文件或目录，包含该项所对应 inode 的位置和文件名，同样也在硬盘里储存，需要时读入内存。


？？？


#设备


？？？


#open系统调用执行过程

#read系统调用执行过程


#从中断到终端

**文件系统(file system)，指的是操作系统中管理（硬盘上）持久存储数据的模块。**

